<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#000000" />
  <title>FlashMoE-128K</title>
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" href="/icon-192.png" />
  <link rel="apple-touch-icon" href="/icon-192.png" />
  <script type="module" src="https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.46"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Courier New', monospace; background:#000; color:#0f0; margin:0; padding:0; }
    .glitch { animation:glitch 3s infinite; }
    @keyframes glitch{0%,100%{text-shadow:0 0 10px #0f0}20%{text-shadow:-4px 0 #f0f,4px 0 #0ff}}
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <header class="text-center py-8">
    <h1 class="text-5xl font-bold glitch">FlashMoE-128K</h1>
    <p id="status" class="text-sm mt-4">Initializing council…</p>
  </header>

  <main id="chat" class="flex-1 overflow-y-auto px-4 pb-32 space-y-4"></main>

  <footer class="fixed bottom-0 left-0 right-0 bg-black border-t-4 border-cyan-500 p-4">
    <select id="model" class="w-full mb-2 p-2 bg-black border border-pink-600 text-green-400">
      <option value="Qwen2.5-7B-Instruct-q4f16_1-MLC">Qwen2.5-7B (fast)</option>
      <option value="Llama-3.1-8B-Instruct-q4f16_1-MLC">Llama-3.1-8B</option>
      <option value="DeepSeek-Coder-V2-Lite-q4f16_1-MLC">DeepSeek-Coder</option>
    </select>
    <textarea id="input" rows="3" placeholder="Speak…" class="w-full p-3 bg-black border-2 border-pink-600 text-green-400"></textarea>
    <button id="send" class="mt-2 w-full bg-gradient-to-r from-pink-600 to-cyan-600 text-black font-bold py-4">JACK IN</button>
  </footer>

  <script type="module">
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const send = document.getElementById('send');
    const status = document.getElementById('status');
    const modelSelect = document.getElementById('model');
    let engine = null;

    async function init() {
      if (!('gpu' in navigator)) { status.textContent = "No WebGPU → using demo mode"; return; }
      status.textContent = "Loading " + modelSelect.value + "…";
      engine = await WebLLM.createMLCEngine(modelSelect.value, {
        initProgressCallback: p => status.textContent = `Downloading… ${Math.round(p.progress*100)}%`
      });
      status.textContent = "FlashMoE-128K ready • WebGPU active";
    }

    modelSelect.onchange = () => { engine = null; init(); };

    send.onclick = async () => {
      const msg = input.value.trim(); if (!msg) return;
      addMsg("You", msg); input.value = "";
      if (!engine) { addMsg("System", "WebGPU not available — demo mode"); return; }
      const reply = await engine.chat.completions.create({
        messages: [{role:"user", content: msg}],
        temperature: 0.8, max_tokens: 512
      });
      addMsg("MoE", reply.choices[0].message.content);
    };

    function addMsg(sender, text) {
      const div = document.createElement('div');
      div.innerHTML = `<span class="text-pink-500 font-bold">${sender}:</span> <span class="text-green-400">${text.replace(/\n/g,'<br>')}</span>`;
      chat.appendChild(div); chat.scrollTop = chat.scrollHeight;
    }

    input.addEventListener('keypress', e => e.key==='Enter' && !e.shiftKey && (e.preventDefault(), send.click()));
    init();
  </script>
</body>
</html>
